---
title: "Limpieza y unión de la data de RENAMU"
description: |
  En este artículo veremos cómo limpiar la data de RENAMU en R.
author:
  - name: Santiago Sotelo 
    url: https://santiagosotelo.netlify.app/
    orcid_id: 0000-0002-9739-9964
    affiliation: Q-LAB PUCP
    affiliation_url: https://qlab.pucp.edu.pe/
date: "`r Sys.Date()`"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 2

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=FALSE)
```

```{r, eval=TRUE, echo=FALSE}
knitr::include_graphics("figuras/rstudio.jpg")
```

# Setup

```{r}
#paquetes
pacman::p_load(here, tidyverse, haven, rio, janitor, glue, sjlabelled)

```

# Importar data

Módulo: Competencias y Funciones de la Municipalidad

```{r}
#funcion importar desde internet
descargar_renamu<-function(link){
  temp <- tempdir()

  tf = tempfile(tmpdir=temp, fileext=".zip")
  
  download.file(link, tf)
  
  direc<-
  dirname(
  unzip(tf, 
        files=grep('\\.sav$', unzip(tf, list=TRUE, exdir=temp, overwrite=TRUE)$Name, ignore.case=TRUE, value=TRUE), 
        exdir=temp, 
        overwrite=TRUE )[1]
  )

  file.list <- list.files(path = direc,
                          full.names = TRUE,
                          pattern='.sav')
  
  return(lapply(file.list, read_sav))
}

#2016-2020
renamu_m4_2016<-descargar_renamu("http://iinei.inei.gob.pe/iinei/srienaho/descarga/SPSS/538-Modulo730.zip") %>% 
  map(~.x %>% 
        #limpiar nombres
        clean_names() %>% 
        #todas las variables que tienen vfi ponerle la misma etiqueta de variable
        mutate(across(starts_with("vfi_"), ~set_label(., label = "¿Municipalidad informó?"))) %>% 
        #borrar variable filter si existe.
        {if ("filter" %in% names(.)) select(., -c(filter)) else .} %>%
        #cambiar nombre p25 = instru_des
        rename_with( ~ str_replace(.x, pattern = "p25", replacement = "instru_des"),
                     matches("p25")) %>% 
        #p26 = consejo_local
        rename_with( ~ str_replace(.x, pattern = "p26", replacement = "consejo_local"),
                     matches("p26")) %>% 
        #p27 = activid_ej
        rename_with( ~ str_replace(.x, pattern = "p27", replacement = "activid_ej"),
                     matches("p27")) %>% 
        #p28 = catastro
        rename_with( ~ str_replace(.x, pattern = "p28", replacement = "catastro"),
                     matches("p28")) %>% 
        #p29 = presu_resul
        rename_with( ~ str_replace(.x, pattern = "p29", replacement = "presu_resul"),
                     matches("p29")) %>% 
        #p30 = tiene_tupa
        rename_with( ~ str_replace(.x, pattern = "p30", replacement = "tiene_tupa"),
                     matches("p30")) %>% 
        #p31 = ratifica_tupa
        rename_with( ~ str_replace(.x, pattern = "p31", replacement = "ratifica_tupa"),
                     matches("p31")) %>% 
        #p32 = publica_tupa
        rename_with( ~ str_replace(.x, pattern = "p32", replacement = "publica_tupa"),
                     matches("p32")) %>% 
        #p33 = proced_admin
        rename_with( ~ str_replace(.x, pattern = "p33", replacement = "proced_admin"),
                     matches("p33")) %>% 
        #p34 = presu_resul
        rename_with( ~ str_replace(.x, pattern = "p34", replacement = "canal_atencion"),
                     matches("p34")) %>% 
        #p35 = mod_pago
        rename_with( ~ str_replace(.x, pattern = "p35", replacement = "mod_pago"),
                     matches("p35")) %>% 
        #p36 = personal_tribu
        rename_with( ~ str_replace(.x, pattern = "p36", replacement = "personal_tribu"),
                     matches("p36")) %>% 
        #p37 = ej_coactiva
        rename_with( ~ str_replace(.x, pattern = "p37", replacement = "ej_coactiva"),
                     matches("p37")) %>% 
        #p38 = sistema_inf
        rename_with( ~ str_replace(.x, pattern = "p38", replacement = "sistema_inf"),
                     matches("p38")) %>% 
        #p39 = licencia_func
        rename_with( ~ str_replace(.x, pattern = "p39", replacement = "licencia_func"),
                     matches("p39")) %>% 
        #p40 = licencia_urb
        rename_with( ~ str_replace(.x, pattern = "p40", replacement = "licencia_urb"),
                     matches("p40")) %>% 
        #p41 = licencia_edif
        rename_with( ~ str_replace(.x, pattern = "p41", replacement = "licencia_edif"),
                     matches("p41")) %>% 
        #p42 = verifica_obras
        rename_with( ~ str_replace(.x, pattern = "p42", replacement = "verifica_obras"),
                     matches("p42")) %>% 
        #p43 = terrenos_prop
        rename_with( ~ str_replace(.x, pattern = "p43", replacement = "terrenos_prop"),
                     matches("p43")) %>% 
        #p44 = repara_caminos1
        rename_with( ~ str_replace(.x, pattern = "p44", replacement = "repara_camino1"),
                     matches("p44")) %>% 
        rename(
          #ids
          departamento=nom_dpto,provincia=nom_prov,distrito=nom_dist
          )
      )

renamu_m4_2017<-descargar_renamu("http://iinei.inei.gob.pe/iinei/srienaho/descarga/SPSS/594-Modulo730.zip") %>% 
    map(~.x %>% 
        #limpiar nombres
        clean_names() %>% 
        #todas las variables que tienen vfi ponerle la misma etiqueta de variable
        mutate(across(starts_with("vfi_"), ~set_label(., label = "¿Municipalidad informó?"))) %>% 
        #borrar variable filter si existe.
        {if ("filter" %in% names(.)) select(., -c(filter)) else .} %>%
        #cambiar nombre p25 = instru_des
        rename_with( ~ str_replace(.x, pattern = "p25", replacement = "instru_des"),
                     matches("p25")) %>% 
        #p26 = consejo_local
        rename_with( ~ str_replace(.x, pattern = "p26", replacement = "consejo_local"),
                     matches("p26")) %>% 
        #p27 = activid_ej
        rename_with( ~ str_replace(.x, pattern = "p27", replacement = "activid_ej"),
                     matches("p27")) %>% 
        #p28 = catastro
        rename_with( ~ str_replace(.x, pattern = "p28", replacement = "catastro"),
                     matches("p28")) %>% 
        #p29 = presu_resul
        rename_with( ~ str_replace(.x, pattern = "p29", replacement = "presu_resul"),
                     matches("p29")) %>% 
        #p30 = tiene_tupa
        rename_with( ~ str_replace(.x, pattern = "p30", replacement = "tiene_tupa"),
                     matches("p30")) %>% 
        #p31 = ratifica_tupa
        rename_with( ~ str_replace(.x, pattern = "p31", replacement = "ratifica_tupa"),
                     matches("p31")) %>% 
        #p32 = publica_tupa
        rename_with( ~ str_replace(.x, pattern = "p32", replacement = "publica_tupa"),
                     matches("p32")) %>% 
        #p33 = proced_admin
        rename_with( ~ str_replace(.x, pattern = "p33", replacement = "proced_admin"),
                     matches("p33")) %>% 
        #p34 = presu_resul
        rename_with( ~ str_replace(.x, pattern = "p34", replacement = "canal_atencion"),
                     matches("p34")) %>% 
        #p35 = mod_pago
        rename_with( ~ str_replace(.x, pattern = "p35", replacement = "mod_pago"),
                     matches("p35")) %>% 
        #p36 = personal_tribu
        rename_with( ~ str_replace(.x, pattern = "p36", replacement = "personal_tribu"),
                     matches("p36")) %>% 
        #p37 = ej_coactiva
        rename_with( ~ str_replace(.x, pattern = "p37", replacement = "ej_coactiva"),
                     matches("p37")) %>% 
        #p38 = sistema_inf
        rename_with( ~ str_replace(.x, pattern = "p38", replacement = "sistema_inf"),
                     matches("p38")) %>% 
        #p39 = licencia_func
        rename_with( ~ str_replace(.x, pattern = "p39", replacement = "licencia_func"),
                     matches("p39")) %>% 
        #p40 = licencia_urb
        rename_with( ~ str_replace(.x, pattern = "p40", replacement = "licencia_urb"),
                     matches("p40")) %>% 
        #p41 = licencia_edif
        rename_with( ~ str_replace(.x, pattern = "p41", replacement = "licencia_edif"),
                     matches("p41")) %>% 
        #p42 = verifica_obras
        rename_with( ~ str_replace(.x, pattern = "p42", replacement = "verifica_obras"),
                     matches("p42")) %>% 
        #p43 = terrenos_prop
        rename_with( ~ str_replace(.x, pattern = "p43", replacement = "terrenos_prop"),
                     matches("p43")) %>% 
        #p44 = repara_caminos1
        rename_with( ~ str_replace(.x, pattern = "p44", replacement = "repara_camino1"),
                     matches("p44"))
      )

renamu_m4_2018<-descargar_renamu("http://iinei.inei.gob.pe/iinei/srienaho/descarga/SPSS/624-Modulo1344.zip") %>% 
      map(~.x %>% 
        #limpiar nombres
        clean_names() %>% 
        #todas las variables que tienen vfi ponerle la misma etiqueta de variable
        mutate(across(starts_with("vfi_"), ~set_label(., label = "¿Municipalidad informó?"))) %>% 
        #borrar variable filter si existe.
        {if ("filter" %in% names(.)) select(., -c(filter)) else .} %>%
        #cambiar nombre p23 = instru_des
        rename_with( ~ str_replace(.x, pattern = "p23", replacement = "instru_des"),
                     matches("p23")) %>% 
        #p24 = consejo_local
        rename_with( ~ str_replace(.x, pattern = "p24", replacement = "consejo_local"),
                     matches("p24")) %>% 
        #p25 = activid_ej
        rename_with( ~ str_replace(.x, pattern = "p25", replacement = "activid_ej"),
                     matches("p25")) %>% 
        #p26 = presu_resul
        rename_with( ~ str_replace(.x, pattern = "p26", replacement = "presu_resul"),
                     matches("p26")) %>% 
        #p27 = tiene_tupa
        rename_with( ~ str_replace(.x, pattern = "p27", replacement = "tiene_tupa"),
                     matches("p27")) %>% 
        #p28 = ratifica_tupa
        rename_with( ~ str_replace(.x, pattern = "p28", replacement = "ratifica_tupa"),
                     matches("p28")) %>% 
        #p29 = publica_tupa
        rename_with( ~ str_replace(.x, pattern = "p29", replacement = "publica_tupa"),
                     matches("p29")) %>% 
        #p30 = proced_admin
        rename_with( ~ str_replace(.x, pattern = "p30", replacement = "proced_admin"),
                     matches("p30")) %>% 
        #p31 = presu_resul
        rename_with( ~ str_replace(.x, pattern = "p31", replacement = "canal_atencion"),
                     matches("p31")) %>% 
        #p32 = mod_pago
        rename_with( ~ str_replace(.x, pattern = "p32", replacement = "mod_pago"),
                     matches("p32")) %>% 
        #p33 = personal_tribu
        rename_with( ~ str_replace(.x, pattern = "p33", replacement = "personal_tribu"),
                     matches("p33")) %>% 
        #p34 = ej_coactiva
        rename_with( ~ str_replace(.x, pattern = "p34", replacement = "ej_coactiva"),
                     matches("p34")) %>% 
        #p35 = sistema_inf
        rename_with( ~ str_replace(.x, pattern = "p35", replacement = "sistema_inf"),
                     matches("p35")) %>% 
        #p36 = licencia_func
        rename_with( ~ str_replace(.x, pattern = "p36", replacement = "licencia_func"),
                     matches("p36")) %>% 
        #p37 = licencia_urb
        rename_with( ~ str_replace(.x, pattern = "p37", replacement = "licencia_urb"),
                     matches("p37")) %>% 
        #p38 = licencia_edif
        rename_with( ~ str_replace(.x, pattern = "p38", replacement = "licencia_edif"),
                     matches("p38")) %>% 
        #p39 = verifica_obras
        rename_with( ~ str_replace(.x, pattern = "p39", replacement = "verifica_obras"),
                     matches("p39")) %>% 
        #p40 = terrenos_prop
        rename_with( ~ str_replace(.x, pattern = "p40", replacement = "terrenos_prop"),
                     matches("p40")) %>% 
        #p41 = normas_sunarp
        rename_with( ~ str_replace(.x, pattern = "p41", replacement = "normas_sunarp"),
                     matches("p41")) %>% 
        #p42 = repara_caminos1
        rename_with( ~ str_replace(.x, pattern = "p42", replacement = "repara_camino1"),
                     matches("p42"))
      )

renamu_m4_2019<-descargar_renamu("http://iinei.inei.gob.pe/iinei/srienaho/descarga/SPSS/656-Modulo1485.zip") %>% 
  map(~.x %>% 
        #limpiar nombres
        clean_names() %>% 
        #todas las variables que tienen vfi ponerle la misma etiqueta de variable
        mutate(across(starts_with("vfi_"), ~set_label(., label = "¿Municipalidad informó?"))) %>% 
        #borrar variable filter si existe.
        {if ("filter" %in% names(.)) select(., -c(filter)) else .} %>%
        #cambiar nombre p23 = instru_des
        rename_with( ~ str_replace(.x, pattern = "p23", replacement = "instru_des"),
                     matches("p23")) %>% 
        #p24 = consejo_local
        rename_with( ~ str_replace(.x, pattern = "p24", replacement = "consejo_local"),
                     matches("p24")) %>% 
        #p25 = activid_ej
        rename_with( ~ str_replace(.x, pattern = "p25", replacement = "activid_ej"),
                     matches("p25")) %>% 
        #p26 = tiene_tupa
        rename_with( ~ str_replace(.x, pattern = "p26", replacement = "tiene_tupa"),
                     matches("p26")) %>% 
        #p27 = ratifica_tupa
        rename_with( ~ str_replace(.x, pattern = "p27", replacement = "ratifica_tupa"),
                     matches("p27")) %>% 
        #p28 = publica_tupa
        rename_with( ~ str_replace(.x, pattern = "p28", replacement = "publica_tupa"),
                     matches("p28")) %>% 
        #p29 = proced_admin
        rename_with( ~ str_replace(.x, pattern = "p29", replacement = "proced_admin"),
                     matches("p29")) %>% 
        #p30 = presu_resul
        rename_with( ~ str_replace(.x, pattern = "p30", replacement = "canal_atencion"),
                     matches("p30")) %>% 
        #p31 = mod_pago
        rename_with( ~ str_replace(.x, pattern = "p31", replacement = "mod_pago"),
                     matches("p31")) %>% 
        #p32 = personal_tribu
        rename_with( ~ str_replace(.x, pattern = "p32", replacement = "personal_tribu"),
                     matches("p32")) %>% 
        #p33 = ej_coactiva
        rename_with( ~ str_replace(.x, pattern = "p33", replacement = "ej_coactiva"),
                     matches("p33")) %>% 
        #p34 = licencia_func
        rename_with( ~ str_replace(.x, pattern = "p34", replacement = "licencia_func"),
                     matches("p34")) %>% 
        #p37 = licencia_urb
        rename_with( ~ str_replace(.x, pattern = "p37", replacement = "licencia_urb"),
                     matches("p37")) %>% 
        #p35 = licencia_edif
        rename_with( ~ str_replace(.x, pattern = "p35", replacement = "licencia_edif"),
                     matches("p35")) %>% 
        #p36 = verifica_obras
        rename_with( ~ str_replace(.x, pattern = "p36", replacement = "verifica_obras"),
                     matches("p36")) %>% 
        #p38 = terrenos_prop
        rename_with( ~ str_replace(.x, pattern = "p38", replacement = "terrenos_prop"),
                     matches("p38")) %>% 
        #p39 = normas_sunarp
        rename_with( ~ str_replace(.x, pattern = "p39", replacement = "normas_sunarp"),
                     matches("p39")) %>% 
        #p40a = repara_caminos1
        rename_with( ~ str_replace(.x, pattern = "p40a", replacement = "repara_camino1"),
                     matches("p40a")) %>% 
        #p40b = repara_caminos2
        rename_with( ~ str_replace(.x, pattern = "p40b", replacement = "repara_camino2"),
                     matches("p40b")) %>% 
        rename(
          #ids
          catmuni=tipomuni
          ))

renamu_m4_2020<-descargar_renamu("http://iinei.inei.gob.pe/iinei/srienaho/descarga/SPSS/730-Modulo1590.zip") %>% 
  map(~.x %>% 
        #limpiar nombres
        clean_names() %>% 
        #todas las variables que tienen vfi ponerle la misma etiqueta de variable
        mutate(across(starts_with("vfi_"), ~set_label(., label = "¿Municipalidad informó?"))) %>% 
        #borrar variable filter si existe.
        {if ("filter" %in% names(.)) select(., -c(filter)) else .} %>%
        #cambiar nombre p23 = instru_des
        rename_with( ~ str_replace(.x, pattern = "p23", replacement = "instru_des"),
                     matches("p23")) %>% 
        #p24 = consejo_local
        rename_with( ~ str_replace(.x, pattern = "p24", replacement = "consejo_local"),
                     matches("p24")) %>% 
        #p25 = activid_ej
        rename_with( ~ str_replace(.x, pattern = "p25", replacement = "activid_ej"),
                     matches("p25")) %>% 
        #p26 = tiene_tupa
        rename_with( ~ str_replace(.x, pattern = "p26", replacement = "tiene_tupa"),
                     matches("p26")) %>% 
        #p27 = ratifica_tupa
        rename_with( ~ str_replace(.x, pattern = "p27", replacement = "ratifica_tupa"),
                     matches("p27")) %>% 
        #p28 = publica_tupa
        rename_with( ~ str_replace(.x, pattern = "p28", replacement = "publica_tupa"),
                     matches("p28")) %>% 
        #p29 = proced_admin
        rename_with( ~ str_replace(.x, pattern = "p29", replacement = "proced_admin"),
                     matches("p29")) %>% 
        #p30 = presu_resul
        rename_with( ~ str_replace(.x, pattern = "p30", replacement = "canal_atencion"),
                     matches("p30")) %>% 
        #p31 = mod_pago
        rename_with( ~ str_replace(.x, pattern = "p31", replacement = "mod_pago"),
                     matches("p31")) %>% 
        #p32 = personal_tribu
        rename_with( ~ str_replace(.x, pattern = "p32", replacement = "personal_tribu"),
                     matches("p32")) %>% 
        #p33 = ej_coactiva
        rename_with( ~ str_replace(.x, pattern = "p33", replacement = "ej_coactiva"),
                     matches("p33")) %>% 
        #p34 = licencia_func
        rename_with( ~ str_replace(.x, pattern = "p34", replacement = "licencia_func"),
                     matches("p34")) %>% 
        #p37 = licencia_urb
        rename_with( ~ str_replace(.x, pattern = "p37", replacement = "licencia_urb"),
                     matches("p37")) %>% 
        #p35 = licencia_edif
        rename_with( ~ str_replace(.x, pattern = "p35", replacement = "licencia_edif"),
                     matches("p35")) %>% 
        #p36 = verifica_obras
        rename_with( ~ str_replace(.x, pattern = "p36", replacement = "verifica_obras"),
                     matches("p36")) %>% 
        #p38 = terrenos_prop
        rename_with( ~ str_replace(.x, pattern = "p38", replacement = "terrenos_prop"),
                     matches("p38")) %>% 
        #p39 = normas_sunarp
        rename_with( ~ str_replace(.x, pattern = "p39", replacement = "normas_sunarp"),
                     matches("p39")) %>%
        rename(
          #ids
          catmuni=tipomuni
          ))


```

# Limpieza

```{r}

#crear función para rutina de limpieza de las observaciones y hacer "merge"
limpieza_data<-function(data){
  
  data %>%
  map(~.x %>%
        clean_names() %>%
        {
          if("idmunici" %in% names(.)) filter(.,!(is.na(idmunici) | 
                                                idmunici %in% "" | 
                                                str_detect(idmunici, "Fuente") |
                                                str_detect(idmunici, ","))) else .
        }
  ) %>%
  reduce(full_join, by=c("idmunici", "ccdd", "ccpp", "ccdi")) #optando por usar de id solo ubigeos

}

#aplicar rutina de limpieza a elementos que empiezan con renamu_m4
renamu<-
mget(ls(pattern = '^renamu_m4')) %>%
  map(~.x %>%
        limpieza_data(.)
  )

#limpieza adicional
renamu1<-
renamu %>% 
  map(~.x %>% 
          rename(tipomuni=catmuni.x,
                 nom_dpto=departamento.x,
                 nom_prov=provincia.x,
                 nom_dist=distrito.x) %>% 
        {
        if("consejo_local.x" %in% names(.)) rename(.,consejo_local=consejo_local.x) else .
        } %>%
        {
        if("tiene_tupa.x" %in% names(.)) rename(.,tiene_tupa=tiene_tupa.x) else .
        } %>%
        select(-starts_with("catmuni")) %>%
        select(-starts_with("departamento")) %>%
        select(-starts_with("provincia")) %>%
        select(-starts_with("distrito")) %>%
        select(-starts_with("catmuni")) %>%
        {
        if("consejo_local" %in% names(.)) select(., -c(starts_with("consejo_local") & ends_with("y")), -c(starts_with("consejo_local") & ends_with("x"))) else .
        } %>% 
        {
        if("tiene_tupa" %in% names(.)) select(., -c(starts_with("tiene_tupa") & -ends_with("x")), -c(starts_with("tiene_tupa") & ends_with("y"))) else .
        }
      )
#ponerle el año
renamu2<- Map(cbind, renamu1, year=names(renamu1)) %>% map(~.x %>% mutate(year=str_sub(year, start = -4)))

#diccionario de códigos
diccionarios<- renamu2 %>% map(~.x %>% labelled::look_for(details = TRUE) %>% select(c(variable, label, value_labels, class, range)))
diccionarios$renamu_m4_2016 %>% as.data.frame() %>% export("renamu_m4_2016_dic1.xlsx")
diccionarios$renamu_m4_2017 %>% as.data.frame() %>% export("renamu_m4_2017_dic1.xlsx")
diccionarios$renamu_m4_2018 %>% as.data.frame() %>% export("renamu_m4_2018_dic1.xlsx")
diccionarios$renamu_m4_2019 %>% as.data.frame() %>% export("renamu_m4_2019_dic1.xlsx")
diccionarios$renamu_m4_2020 %>% as.data.frame() %>% export("renamu_m4_2020_dic1.xlsx")

# diccionarios %>% map(~.x %>% select(c(variable, label, value_labels, class, range)))) # %>% reduce(full_join, by= "variable") %>% filter(str_detect(variable, "instru_des") | variable %in% "year") %>% View()

```


# Exportar con automatización

Se exportó con automatización.

```{r, warning=FALSE, results='hide',message=FALSE}


exportar<-function(data){
  nombre<-unique(data$year)
  
  data<-data %>% 
    select(-year)
    
  output<-data %>%
          clean_names() %>% 
          write_dta(glue("data/renamu_m4_{nombre}.dta"), version = 15)# %>% write_sav(glue("data/{nombre}.sav")))
  
}

renamu2 %>% 
  map(~.x %>% 
        exportar()) %>% 
  invisible()

```



